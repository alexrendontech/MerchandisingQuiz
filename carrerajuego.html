<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèá Sistema Profesional de Carreras</title>
    <style>
        :root {
            --primary-color: #1a365d;
            --secondary-color: #2d3748;
            --accent-color: #3182ce;
            --success-color: #38a169;
            --warning-color: #d69e2e;
            --danger-color: #e53e3e;
            --gold-color: #ffd700;
            --silver-color: #c0c0c0;
            --bronze-color: #cd7f32;
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-dark: rgba(26, 54, 93, 0.95);
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 15px 40px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--bg-dark);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            color: white;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 4rem);
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--gold-color), #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .panel h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .player-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .player-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }

        .player-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .gender-select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-width: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2c5aa0;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #2f855a;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c53030;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--accent-color);
        }

        .stat-card h4 {
            color: var(--secondary-color);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .race-container {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            position: relative;
        }

        .race-track {
            background: linear-gradient(to right, #8b4513, #a0522d);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            min-height: 400px;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .race-track::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 48px,
                rgba(255, 255, 255, 0.1) 48px,
                rgba(255, 255, 255, 0.1) 52px
            );
            pointer-events: none;
        }

        .lane {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            position: relative;
            min-height: 70px;
            backdrop-filter: blur(5px);
        }

        .lane:nth-child(even) {
            background: rgba(255, 255, 255, 0.15);
        }

        .horse-container {
            position: relative;
            width: 50px;
            height: 50px;
            transition: transform 0.1s ease-out;
            z-index: 10;
        }

        .horse {
            font-size: 36px;
            animation: gallop 0.6s infinite;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
            transform-origin: center;
        }

        @keyframes gallop {
            0%, 100% { transform: rotate(-3deg) translateY(0px); }
            25% { transform: rotate(2deg) translateY(-4px); }
            50% { transform: rotate(-2deg) translateY(-2px); }
            75% { transform: rotate(3deg) translateY(-5px); }
        }

        .player-info {
            margin-left: 20px;
            flex: 1;
        }

        .player-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 5px;
        }

        .player-position {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 8px 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #68d391);
            border-radius: 0 0 8px 8px;
            transition: width 0.1s ease-out;
            position: relative;
        }

        .finish-line {
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            width: 6px;
            background: repeating-linear-gradient(
                0deg,
                white 0px,
                white 12px,
                #333 12px,
                #333 24px
            );
            border-radius: 3px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }

        .leaderboard {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow-light);
        }

        .leaderboard h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 8px;
            transition: var(--transition);
            border: 1px solid #e2e8f0;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-light);
        }

        .leaderboard-item.first {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-color: var(--gold-color);
        }

        .leaderboard-item.second {
            background: linear-gradient(135deg, #c0c0c0, #e2e8f0);
            border-color: var(--silver-color);
        }

        .leaderboard-item.third {
            background: linear-gradient(135deg, #cd7f32, #ed8936);
            border-color: var(--bronze-color);
        }

        .player-rank {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
        }

        .rank-medal {
            font-size: 1.5rem;
        }

        .winner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .winner-content {
            background: linear-gradient(135deg, var(--gold-color), #ffed4e);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-heavy);
            animation: modalPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes modalPop {
            0% { transform: scale(0.3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .winner-content h2 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .winner-horse {
            font-size: 4rem;
            margin: 20px 0;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        .winner-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            backdrop-filter: blur(15px);
        }

        .countdown-number {
            font-size: 8rem;
            font-weight: 900;
            color: var(--gold-color);
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .bulk-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bulk-input {
            flex: 1;
            min-width: 200px;
        }

        .players-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .player-preview {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scrollable-track {
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) #f1f1f1;
        }

        .scrollable-track::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-track::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .scrollable-track::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .controls-panel {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .player-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .winner-content {
                padding: 30px 20px;
            }
            
            .countdown-number {
                font-size: 4rem;
            }
        }

        @media (max-width: 480px) {
            .lane {
                padding: 10px;
                min-height: 60px;
            }
            
            .horse {
                font-size: 28px;
            }
            
            .player-name {
                font-size: 1rem;
            }
            
            .horse-container {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèá Sistema Profesional de Carreras</h1>
            <p>Plataforma avanzada para competencias ecuestres</p>
        </div>

        <button class="btn btn-primary sound-toggle" onclick="toggleSound()">üîä</button>

        <div class="controls-panel">
            <div class="panel">
                <h3>üë• Gesti√≥n de Participantes</h3>
                <div class="player-management">
                    <div class="bulk-controls">
                        <textarea class="bulk-input player-input" id="bulkInput" 
                                  placeholder="Agregar m√∫ltiples jugadores (uno por l√≠nea)&#10;Ejemplo:&#10;Juan P√©rez&#10;Mar√≠a Garc√≠a&#10;Carlos L√≥pez"></textarea>
                        <button class="btn btn-primary" onclick="addBulkPlayers()">
                            <span>üìù</span> Agregar en Lote
                        </button>
                    </div>
                    
                    <div class="player-input-group">
                        <input type="text" class="player-input" id="singlePlayerInput" 
                               placeholder="Nombre del participante" maxlength="30">
                        <select class="gender-select" id="genderSelect">
                            <option value="auto">Auto</option>
                            <option value="male">Masculino</option>
                            <option value="female">Femenino</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="addSinglePlayer()">
                            <span>‚ûï</span> Agregar
                        </button>
                    </div>
                    
                    <div class="players-list" id="playersList">
                        <p>No hay participantes registrados</p>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="btn btn-danger btn-sm" onclick="clearAllPlayers()">
                            <span>üóëÔ∏è</span> Limpiar Todo
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="randomizePlayers()">
                            <span>üé≤</span> Aleatorizar
                        </button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üéÆ Control de Carrera</h3>
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="startRace()" id="startButton">
                        <span>üöÄ</span> Iniciar Carrera
                    </button>
                    <button class="btn btn-danger" onclick="stopRace()" id="stopButton" disabled>
                        <span>‚èπÔ∏è</span> Detener
                    </button>
                    <button class="btn btn-primary" onclick="resetRace()">
                        <span>üîÑ</span> Reiniciar
                    </button>
                    <button class="btn btn-warning" onclick="exportData()">
                        <span>üìä</span> Exportar Datos
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>Participantes</h4>
                <div class="value" id="playerCount">0</div>
            </div>
            <div class="stat-card">
                <h4>Carreras Completadas</h4>
                <div class="value" id="raceCount">0</div>
            </div>
            <div class="stat-card">
                <h4>Tiempo Actual</h4>
                <div class="value" id="raceTime">0.0s</div>
            </div>
            <div class="stat-card">
                <h4>Velocidad Promedio</h4>
                <div class="value" id="avgSpeed">0 km/h</div>
            </div>
        </div>

        <div class="race-container">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">üèÅ Pista de Carreras</h3>
            <div class="race-track scrollable-track" id="raceTrack">
                <div class="finish-line"></div>
                <div style="text-align: center; padding: 50px; color: rgba(255,255,255,0.7);">
                    <p>Registra participantes para comenzar la carrera</p>
                </div>
            </div>
        </div>

        <div class="leaderboard">
            <h3>üèÜ Tabla de Posiciones</h3>
            <div id="leaderboardList">
                <p style="text-align: center; color: #666; padding: 20px;">
                    Los resultados aparecer√°n aqu√≠ despu√©s de las carreras
                </p>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div class="winner-modal" id="winnerModal">
        <div class="winner-content">
            <h2>üéâ ¬°CAMPE√ìN! üéâ</h2>
            <div class="winner-horse" id="winnerHorse">üèá</div>
            <div class="winner-name" id="winnerName">Participante</div>
            <button class="btn btn-primary" onclick="hideWinner()">
                <span>‚ú®</span> Continuar
            </button>
        </div>
    </div>

    <div class="countdown-overlay" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <script>
        class ProfessionalHorseRace {
            constructor() {
                this.players = [];
                this.raceActive = false;
                this.raceCount = 0;
                this.leaderboard = new Map();
                this.soundEnabled = true;
                this.raceStartTime = 0;
                this.raceInterval = null;
                this.positions = [];
                
                // Caballos por g√©nero
                this.horses = {
                    male: ['üêé', 'üèáüèª', 'üèáüèº', 'üèáüèΩ', 'üèáüèæ', 'üèáüèø'],
                    female: ['üê¥', 'üèáüèª‚Äç‚ôÄÔ∏è', 'üèáüèº‚Äç‚ôÄÔ∏è', 'üèáüèΩ‚Äç‚ôÄÔ∏è', 'üèáüèæ‚Äç‚ôÄÔ∏è', 'üèáüèø‚Äç‚ôÄÔ∏è'],
                    neutral: ['ü¶Ñ', 'üêé', 'üê¥']
                };
                
                // Nombres comunes para detecci√≥n autom√°tica de g√©nero
                this.maleNames = ['juan', 'carlos', 'luis', 'miguel', 'antonio', 'francisco', 'manuel', 'pedro', 'alejandro', 'david', 'daniel', 'adrian', 'jose', 'jorge', 'sergio', 'roberto', 'ricardo', 'fernando', 'alberto', 'oscar'];
                this.femaleNames = ['maria', 'ana', 'carmen', 'laura', 'sofia', 'elena', 'isabel', 'patricia', 'monica', 'andrea', 'lucia', 'paula', 'cristina', 'marta', 'sara', 'natalia', 'claudia', 'valeria', 'alejandra', 'gabriela'];
                
                this.colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
                    '#DDA0DD', '#98D8C8', '#F7DC6F', '#85C1E9', '#F8C471',
                    '#82E0AA', '#D2B4DE', '#AED6F1', '#A9DFBF', '#FAD7A0'
                ];
                
                this.initializeAudio();
                this.updateStats();
                this.setupEventListeners();
            }

            initializeAudio() {
                this.audioContext = null;
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio no disponible');
                }
            }

            setupEventListeners() {
                // Eventos de teclado
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && !this.raceActive) {
                        e.preventDefault();
                        this.startRace();
                    }
                    if (e.code === 'KeyR' && e.ctrlKey) {
                        e.preventDefault();
                        this.resetRace();
                    }
                    if (e.code === 'Escape') {
                        this.hideWinner();
                    }
                });

                // Enter en inputs
                document.getElementById('singlePlayerInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.addSinglePlayer();
                    }
                });

                // Inicializar audio en primera interacci√≥n
                document.addEventListener('click', () => {
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                }, { once: true });
            }

            detectGender(name) {
                const cleanName = name.toLowerCase().trim().split(' ')[0];
                
                if (this.maleNames.includes(cleanName)) return 'male';
                if (this.femaleNames.includes(cleanName)) return 'female';
                
                // Detecci√≥n por terminaciones comunes
                if (cleanName.endsWith('a') || cleanName.endsWith('ia') || cleanName.endsWith('ina')) {
                    return 'female';
                }
                if (cleanName.endsWith('o') || cleanName.endsWith('os') || cleanName.endsWith('ez')) {
                    return 'male';
                }
                
                return 'neutral';
            }

            getHorseForPlayer(player) {
                const horses = this.horses[player.gender] || this.horses.neutral;
                return horses[Math.floor(Math.random() * horses.length)];
            }

            playSound(frequency, duration, type = 'sine') {
                if (!this.soundEnabled || !this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log('Error reproduciendo sonido:', e);
                }
            }

            addSinglePlayer() {
                const input = document.getElementById('singlePlayerInput');
                const genderSelect = document.getElementById('genderSelect');
                const name = input.value.trim();
                
                if (!name) {
                    alert('Por favor, ingresa un nombre v√°lido');
                    return;
                }
                
                if (this.players.length >= 500) {
                    alert('Se ha alcanzado el l√≠mite m√°ximo de 500 participantes');
                    return;
                }
                
                if (this.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    alert('Este participante ya est√° registrado');
                    return;
                }
                
                const gender = genderSelect.value === 'auto' ? this.detectGender(name) : genderSelect.value;
                
                const player = {
                    id: Date.now() + Math.random(),
                    name: name,
                    gender: gender,
                    horse: this.getHorseForPlayer({ gender }),
                    wins: 0
                };
                
                this.players.push(player);
                input.value = '';
                this.updatePlayersList();
                this.updateStats();
                this.playSound(523, 0.1);
            }

            addBulkPlayers() {
                const bulkInput = document.getElementById('bulkInput');
                const names = bulkInput.value.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
                
                if (names.length === 0) {
                    alert('Por favor, ingresa al menos un nombre');
                    return;
                }
                
                if (this.players.length + names.length > 500) {
                    alert(`No se pueden agregar ${names.length} participantes. L√≠mite: 500 participantes.`);
                    return;
                }
                
                let added = 0;
                let duplicates = 0;
                
                names.forEach(name => {
                    if (name.length > 30) {
                        name = name.substring(0, 30);
                    }
                    
                    if (!this.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        const gender = this.detectGender(name);
                        const player = {
                            id: Date.now() + Math.random(),
                            name: name,
                            gender: gender,
                            horse: this.getHorseForPlayer({ gender }),
                            wins: 0
                        };
                        this.players.push(player);
                        added++;
                    } else {
                        duplicates++;
                    }
                });
                
                bulkInput.value = '';
                this.updatePlayersList();
                this.updateStats();
                
                let message = `Se agregaron ${added} participantes`;
                if (duplicates > 0) {
                    message += `. ${duplicates} nombres duplicados fueron omitidos`;
                }
                alert(message);
                
                this.playSound(659, 0.2);
            }

            removePlayer(playerId) {
                this.players = this.players.filter(p => p.id !== playerId);
                this.updatePlayersList();
                this.updateStats();
                this.playSound(392, 0.1);
            }

            clearAllPlayers() {
                if (this.players.length === 0) return;
                
                if (confirm('¬øEst√°s seguro de que quieres eliminar todos los participantes?')) {
                    this.players = [];
                    this.updatePlayersList();
                    this.updateStats();
                    this.playSound(330, 0.3);
                }
            }

            randomizePlayers() {
                if (this.players.length < 2) return;
                
                for (let i = this.players.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.players[i], this.players[j]] = [this.players[j], this.players[i]];
                }
                
                this.updatePlayersList();
                this.playSound(440, 0.2);
            }

            updatePlayersList() {
                const playersList = document.getElementById('playersList');
                
                if (this.players.length === 0) {
                    playersList.innerHTML = '<p>No hay participantes registrados</p>';
                    return;
                }
                
                playersList.innerHTML = this.players.map(player => `
                    <div class="player-item">
                        <div class="player-preview">
                            <span style="font-size: 1.5rem;">${player.horse}</span>
                            <div>
                                <div style="font-weight: 600;">${player.name}</div>
                                <div style="font-size: 0.8rem; color: #666;">
                                    ${player.gender === 'male' ? 'Masculino' : player.gender === 'female' ? 'Femenino' : 'Neutro'}
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="game.removePlayer(${player.id})">
                            <span>‚ùå</span>
                        </button>
                    </div>
                `).join('');
            }

            updateStats() {
                document.getElementById('playerCount').textContent = this.players.length;
                document.getElementById('raceCount').textContent = this.raceCount;
                
                if (this.raceActive && this.raceStartTime) {
                    const elapsed = ((Date.now() - this.raceStartTime) / 1000).toFixed(1);
                    document.getElementById('raceTime').textContent = `${elapsed}s`;
                    
                    // Calcular velocidad promedio (simulada)
                    const avgSpeed = (Math.random() * 20 + 35).toFixed(1);
                    document.getElementById('avgSpeed').textContent = `${avgSpeed} km/h`;
                }
            }

            async startRace() {
                if (this.raceActive) return;
                
                if (this.players.length < 2) {
                    alert('Se necesitan al menos 2 participantes para iniciar la carrera');
                    return;
                }
                
                this.raceActive = true;
                this.raceStartTime = Date.now();
                this.positions = new Array(this.players.length).fill(0);
                
                // Actualizar botones
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
                
                this.setupRaceTrack();
                await this.countdown();
                this.runRace();
            }

            setupRaceTrack() {
                const raceTrack = document.getElementById('raceTrack');
                raceTrack.innerHTML = '<div class="finish-line"></div>';
                
                this.players.forEach((player, index) => {
                    const lane = document.createElement('div');
                    lane.className = 'lane';
                    lane.style.borderLeft = `4px solid ${this.colors[index % this.colors.length]}`;
                    
                    lane.innerHTML = `
                        <div class="horse-container" id="horse-${index}">
                            <div class="horse">${player.horse}</div>
                        </div>
                        <div class="player-info">
                            <div class="player-name" style="color: ${this.colors[index % this.colors.length]}">
                                ${player.name}
                            </div>
                            <div class="player-position" id="position-${index}">
                                Posici√≥n: Prepar√°ndose...
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" id="progress-${index}" 
                                 style="background: linear-gradient(90deg, ${this.colors[index % this.colors.length]}, ${this.colors[index % this.colors.length]}80)">
                            </div>
                        </div>
                    `;
                    
                    raceTrack.appendChild(lane);
                });
            }

            async countdown() {
                const countdownOverlay = document.getElementById('countdownOverlay');
                const countdownNumber = document.getElementById('countdownNumber');
                const numbers = ['3', '2', '1', '¬°INICIO!'];
                
                countdownOverlay.style.display = 'flex';
                
                for (let i = 0; i < numbers.length; i++) {
                    countdownNumber.textContent = numbers[i];
                    countdownNumber.style.animation = 'none';
                    
                    // Forzar reflow para reiniciar animaci√≥n
                    countdownNumber.offsetHeight;
                    countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
                    
                    // Sonidos de cuenta regresiva
                    if (i < 3) {
                        this.playSound(800 + (i * 100), 0.3);
                    } else {
                        this.playSound(1200, 0.5);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                countdownOverlay.style.display = 'none';
            }

            runRace() {
                const raceTrack = document.getElementById('raceTrack');
                const trackWidth = raceTrack.offsetWidth - 120; // Margen para l√≠nea de meta
                let winner = null;
                let racePositions = [];
                
                this.raceInterval = setInterval(() => {
                    if (!this.raceActive || winner) {
                        clearInterval(this.raceInterval);
                        return;
                    }
                    
                    // Actualizar posiciones con f√≠sica m√°s realista
                    this.positions.forEach((pos, index) => {
                        if (winner) return;
                        
                        // Velocidad variable con momentum
                        const baseSpeed = 1.5 + (Math.random() * 2);
                        const momentum = Math.sin(Date.now() / 1000 + index) * 0.5;
                        const finalSpeed = Math.max(0.5, baseSpeed + momentum);
                        
                        this.positions[index] += finalSpeed;
                        
                        const horseElement = document.getElementById(`horse-${index}`);
                        const progressElement = document.getElementById(`progress-${index}`);
                        const positionElement = document.getElementById(`position-${index}`);
                        
                        if (horseElement && progressElement && positionElement) {
                            const percentage = Math.min((this.positions[index] / trackWidth) * 100, 100);
                            horseElement.style.transform = `translateX(${this.positions[index]}px)`;
                            progressElement.style.width = `${percentage}%`;
                            
                            // Actualizar posici√≥n en tiempo real
                            racePositions = this.positions
                                .map((pos, idx) => ({ index: idx, position: pos, name: this.players[idx].name }))
                                .sort((a, b) => b.position - a.position);
                            
                            const currentRank = racePositions.findIndex(p => p.index === index) + 1;
                            positionElement.textContent = `Posici√≥n: ${currentRank}¬∞`;
                            
                            // Efectos de sonido aleatorios
                            if (Math.random() < 0.02) {
                                this.playSound(200 + Math.random() * 100, 0.05, 'sawtooth');
                            }
                        }
                        
                        // Verificar ganador
                        if (this.positions[index] >= trackWidth && !winner) {
                            winner = this.players[index];
                            this.endRace(winner, racePositions);
                        }
                    });
                    
                    // Actualizar estad√≠sticas en tiempo real
                    this.updateStats();
                    
                }, 50);
            }

            stopRace() {
                if (!this.raceActive) return;
                
                this.raceActive = false;
                if (this.raceInterval) {
                    clearInterval(this.raceInterval);
                }
                
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
                
                this.playSound(300, 0.5);
            }

            endRace(winner, finalPositions) {
                this.raceActive = false;
                this.raceCount++;
                
                if (this.raceInterval) {
                    clearInterval(this.raceInterval);
                }
                
                // Actualizar botones
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
                
                // Actualizar estad√≠sticas globales
                const currentWins = this.leaderboard.get(winner.name) || 0;
                this.leaderboard.set(winner.name, currentWins + 1);
                
                // Actualizar wins del jugador
                const playerIndex = this.players.findIndex(p => p.id === winner.id);
                if (playerIndex !== -1) {
                    this.players[playerIndex].wins++;
                }
                
                this.updateStats();
                this.updateLeaderboard();
                
                // Mostrar ganador
                document.getElementById('winnerName').textContent = winner.name;
                document.getElementById('winnerHorse').textContent = winner.horse;
                document.getElementById('winnerModal').style.display = 'flex';
                
                // Sonido de victoria √©pico
                this.playVictorySound();
                
                // Actualizar posiciones finales
                setTimeout(() => {
                    finalPositions.forEach((player, index) => {
                        const positionElement = document.getElementById(`position-${player.index}`);
                        if (positionElement) {
                            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                            positionElement.textContent = `${medal} Posici√≥n: ${index + 1}¬∞`;
                        }
                    });
                }, 1000);
            }

            playVictorySound() {
                const victoryMelody = [523, 659, 784, 1047, 1319];
                victoryMelody.forEach((note, index) => {
                    setTimeout(() => {
                        this.playSound(note, 0.4);
                    }, index * 200);
                });
            }

            updateLeaderboard() {
                const leaderboardList = document.getElementById('leaderboardList');
                
                if (this.leaderboard.size === 0) {
                    leaderboardList.innerHTML = `
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Los resultados aparecer√°n aqu√≠ despu√©s de las carreras
                        </p>
                    `;
                    return;
                }
                
                const sortedLeaders = [...this.leaderboard.entries()]
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 20); // Mostrar solo top 20
                
                leaderboardList.innerHTML = sortedLeaders
                    .map(([name, wins], index) => {
                        const medals = ['ü•á', 'ü•à', 'ü•â'];
                        const medal = medals[index] || 'üèÖ';
                        const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                        
                        // Encontrar el jugador para obtener su caballo
                        const player = this.players.find(p => p.name === name);
                        const horse = player ? player.horse : 'üèá';
                        
                        return `
                            <div class="leaderboard-item ${rankClass}">
                                <div class="player-rank">
                                    <span class="rank-medal">${medal}</span>
                                    <span style="font-size: 1.2rem;">${horse}</span>
                                    <span>${name}</span>
                                </div>
                                <div style="font-weight: 600;">
                                    ${wins} victoria${wins !== 1 ? 's' : ''}
                                </div>
                            </div>
                        `;
                    })
                    .join('');
            }

            hideWinner() {
                document.getElementById('winnerModal').style.display = 'none';
            }

            resetRace() {
                if (this.raceActive) {
                    this.stopRace();
                }
                
                this.raceCount = 0;
                this.leaderboard.clear();
                this.positions = [];
                
                // Resetear wins de jugadores
                this.players.forEach(player => {
                    player.wins = 0;
                });
                
                document.getElementById('raceTrack').innerHTML = `
                    <div class="finish-line"></div>
                    <div style="text-align: center; padding: 50px; color: rgba(255,255,255,0.7);">
                        <p>Registra participantes para comenzar la carrera</p>
                    </div>
                `;
                
                this.updateStats();
                this.updateLeaderboard();
                this.hideWinner();
                
                this.playSound(400, 0.3);
            }

            exportData() {
                if (this.players.length === 0 && this.leaderboard.size === 0) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                const data = {
                    timestamp: new Date().toISOString(),
                    totalRaces: this.raceCount,
                    participants: this.players.map(p => ({
                        name: p.name,
                        gender: p.gender,
                        wins: p.wins
                    })),
                    leaderboard: [...this.leaderboard.entries()].map(([name, wins]) => ({
                        name,
                        wins
                    }))
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carreras_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.playSound(660, 0.2);
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                const button = document.querySelector('.sound-toggle');
                button.textContent = this.soundEnabled ? 'üîä' : 'üîá';
                
                if (this.soundEnabled && this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                
                this.playSound(440, 0.1);
            }
        }

        // Inicializar el juego
        const game = new ProfessionalHorseRace();

        // Funciones globales para compatibilidad
        function addSinglePlayer() { game.addSinglePlayer(); }
        function addBulkPlayers() { game.addBulkPlayers(); }
        function startRace() { game.startRace(); }
        function stopRace() { game.stopRace(); }
        function resetRace() { game.resetRace(); }
        function hideWinner() { game.hideWinner(); }
        function toggleSound() { game.toggleSound(); }
        function clearAllPlayers() { game.clearAllPlayers(); }
        function randomizePlayers() { game.randomizePlayers(); }
        function exportData() { game.exportData(); }

        // Prevenir zoom en dispositivos m√≥viles
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
