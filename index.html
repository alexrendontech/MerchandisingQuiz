<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizPlatform - Cuestionarios Interactivos</title>
    <style>
        /* Estilos CSS Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .menu-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .menu-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .menu-card h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #5a67d8;
        }

        .menu-card p {
            color: #666;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .hidden {
            display: none;
        }

        .quiz-creation {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .quiz-creation h2 {
            color: #5a67d8;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input:not([type="radio"]):not([type="checkbox"]), .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:not([type="radio"]):not([type="checkbox"]):focus, .form-group textarea:focus {
            outline: none;
            border-color: #5a67d8;
        }
        
        /* Style for the new image URL input */
        .form-group input.question-image-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input.question-image-input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 10px;
            display: none; /* Hidden by default */
        }


        .question-block {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #5a67d8;
        }

        .question-block .form-group { 
            margin-bottom: 15px;
        }
        .question-block .form-group:last-of-type {
            margin-bottom: 0;
        }

        .option-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-input input[type="text"] { 
            flex: 1;
            margin-right: 10px;
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
        }

        .option-input input[type="text"]:focus {
            border-color: #5a67d8;
        }

        .option-input input[type="radio"], .option-input input[type="checkbox"] {
            margin-left: 5px;
            transform: scale(1.1);
            cursor: pointer;
            accent-color: #5a67d8;
        }

        .option-input label {
            margin-left: 5px;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
            margin-bottom: 0;
        }

        /* Styles for open-ended questions */
        .open-answer-group {
            display: none; /* Hidden by default */
        }
        .open-answer-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .open-answer-group input:focus {
            outline: none;
            border-color: #5a67d8;
        }


        .quiz-player {
            text-align: center;
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 800px;
            margin: 0 auto;
            position: relative; 
        }

        .question-number {
            color: #5a67d8;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #333;
        }

        .question-text img { /* Styling for question images */
            max-width: 100%;
            height: auto;
            margin-top: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        /* Styles for player options */
        .player-option {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left; /* Align text to left inside the option */
        }

        .player-option:hover {
            background: #e2e8f0;
            transform: scale(1.02);
        }

        .player-option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3); /* Make checkbox larger */
            accent-color: #5a67d8;
        }

        .player-option.selected {
            background: #d1e1f8; /* Light blue when selected */
            border-color: #5a67d8;
        }

        .player-option.correct {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
        }

        .player-option.incorrect {
            background: #f56565;
            border-color: #f56565;
            color: white;
        }


        .open-answer-input-player {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            box-sizing: border-box; /* Ensures padding doesn't increase total width */
        }
        .open-answer-input-player:focus {
            outline: none;
            border-color: #5a67d8;
        }


        .option-btn { /* Old style for single select buttons, mostly for reference, replaced by player-option */
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-btn:hover {
            background: #e2e8f0;
            transform: scale(1.02);
        }

        .option-btn.selected {
            background: #5a67d8;
            color: white;
            border-color: #5a67d8;
        }

        .option-btn.correct {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
        }

        .option-btn.incorrect {
            background: #f56565;
            border-color: #f56565;
            color: white;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #e53e3e;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .results {
            text-align: center;
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 20px;
        }

        .quiz-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .quiz-item {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .quiz-item:hover {
            transform: translateY(-5px);
        }

        .quiz-title {
            font-size: 1.3rem;
            color: #5a67d8;
            margin-bottom: 10px;
        }

        .quiz-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #718096;
            margin-bottom: 20px;
        }

        .celebration {
            animation: bounce 0.6s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0px); }
            to { transform: translateY(-20px); }
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5a67d8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Estilos para la tabla de resultados de jugadores */
        .player-results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        .player-results-table th, .player-results-table td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }

        .player-results-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #5a67d8;
        }

        .player-results-table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .player-results-table tr:hover {
            background-color: #edf2f7;
        }

        /* **MEJORADO: Ganador en la tabla de resultados** */
        .player-results-table tr.winner {
            background-color: #e0ffe0; /* Un verde muy claro */
            font-weight: bold;
            color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
            position: relative;
        }
        .player-results-table tr.winner td {
            border-color: #28a745;
        }
        .player-results-table tr.winner td:first-child::before {
            content: 'üëë ';
            margin-right: 5px;
            color: gold;
            font-size: 1.2em;
        }
        
        /* **MEJORADO: Mensajes de retroalimentaci√≥n en el Quiz Player** */
        #feedback-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8); /* Inicia m√°s peque√±o */
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none; /* Permite clics a trav√©s del elemento cuando no est√° visible */
        }
        #feedback-message.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1); /* Crece al mostrarse */
        }
        #feedback-message.correct {
            background-color: rgba(72, 187, 120, 0.95); /* Verde vibrante */
            box-shadow: 0 0 20px rgba(72, 187, 120, 0.6);
        }
        #feedback-message.incorrect {
            background-color: rgba(245, 101, 101, 0.95); /* Rojo vibrante */
            box-shadow: 0 0 20px rgba(245, 101, 101, 0.6);
        }

        /* **MEJORADO: Estilos para el panel de administraci√≥n** */
        .admin-quiz-item {
            background: #f0f8ff; /* Azul muy claro */
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border-left: 6px solid #5a67d8; /* Borde de color */
        }
        .admin-quiz-item h3 {
            color: #5a67d8;
            margin-bottom: 5px;
            font-size: 1.4rem;
        }
        .admin-quiz-item p {
            color: #666;
            font-size: 0.9rem;
        }
        .admin-quiz-item .btn {
            margin-left: 10px;
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        .admin-quiz-item .btn-delete {
            background: #dc3545; /* Rojo para eliminar */
        }
        .admin-quiz-item .btn-delete:hover {
            background: #c82333;
        }
        /* New style for edit button */
        .admin-quiz-item .btn-edit {
            background: #ffc107; /* Amarillo para editar */
            color: #333;
        }
        .admin-quiz-item .btn-edit:hover {
            background: #e0a800;
        }

        #admin-realtime-results {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid #e2e8f0;
        }

        #admin-realtime-results h3 {
            color: #5a67d8;
            margin-bottom: 20px;
            font-size: 1.8rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-screen">
            <div class="header">
                <h1>üéØ QuizPlatform</h1>
                <p>Crea y juega cuestionarios interactivos</p>
            </div>
            
            <div class="main-menu">
                <div class="menu-card" onclick="showCreateQuiz()">
                    <h3>üìù Crear Quiz</h3>
                    <p>Dise√±a tu propio cuestionario con preguntas personalizadas</p>
                    <button class="btn">Empezar a crear</button>
                </div>
                
                <div class="menu-card" onclick="showQuizList()">
                    <h3>üéÆ Jugar Quiz</h3>
                    <p>Elige un cuestionario existente y pon a prueba tus conocimientos</p>
                    <button class="btn">Ver cuestionarios</button>
                </div>
                
                <div class="menu-card" onclick="window.location.href='join_quiz.html'">
                    <h3>üîó Unirme con c√≥digo</h3>
                    <p>√önete a un quiz usando un c√≥digo de sala</p>
                    <button class="btn">Ingresar c√≥digo</button>
                </div>
                <div class="menu-card" onclick="showAdminDashboard()">
                    <h3>üìä Panel de Administraci√≥n</h3>
                    <p>Visualiza los resultados de los jugadores en tiempo real y gestiona quizzes</p>
                    <button class="btn">Acceder al Panel</button>
                </div>
                <div class="menu-card" onclick="window.location.href='roulette.html'">
                    <h3>üé° Ruleta Aleatoria</h3>
                    <p>Selecciona un nombre al azar entre los jugadores de tus quizzes.</p>
                    <button class="btn">Girar Ruleta</button>
                </div>


                 <div class="menu-card" onclick="window.location.href='carrerajuego.html'">
                    <h3>üéÆ Carreras de Caballos</h3>
                    <p>Selecciona un nombre al azar entre los jugadores de tus quizzes.</p>
                    <button class="btn">Gana de Carrera</button>
                </div>

                
            </div>
        </div>

        <div id="create-quiz-screen" class="hidden">
            <button class="btn back-btn" onclick="showMainScreen()">‚Üê Volver</button>
            
            <div class="quiz-creation">
                <h2>Crear Nuevo Cuestionario</h2>
                
                <div class="form-group">
                    <label for="quiz-title">T√≠tulo del Quiz</label>
                    <input type="text" id="quiz-title" placeholder="Ej: Historia de Colombia">
                </div>
                
                <div class="form-group">
                    <label for="quiz-description">Descripci√≥n</label>
                    <textarea id="quiz-description" placeholder="Describe de qu√© trata tu cuestionario..." rows="3"></textarea>
                </div>
                
                <div id="questions-container">
                    </div>
                
                <button class="btn" onclick="addQuestion()">+ Agregar Pregunta</button>
                <button class="btn" onclick="saveQuiz()" style="margin-left: 10px;">üíæ Guardar Quiz</button>
            </div>
        </div>

        <div id="edit-quiz-screen" class="hidden">
            <button class="btn back-btn" onclick="showAdminDashboard()">‚Üê Volver al Panel Admin</button>
            
            <div class="quiz-creation">
                <h2 id="edit-quiz-title-heading">Editar Cuestionario</h2>
                
                <div class="form-group">
                    <label for="edit-quiz-title">T√≠tulo del Quiz</label>
                    <input type="text" id="edit-quiz-title" placeholder="Ej: Historia de Colombia">
                </div>
                
                <div class="form-group">
                    <label for="edit-quiz-description">Descripci√≥n</label>
                    <textarea id="edit-quiz-description" placeholder="Describe de qu√© trata tu cuestionario..." rows="3"></textarea>
                </div>
                
                <div id="edit-questions-container">
                    </div>
                
                <button class="btn" onclick="addQuestion('edit')">+ Agregar Pregunta</button>
                <button class="btn" id="update-quiz-btn" onclick="updateQuiz()" style="margin-left: 10px;">‚úÖ Actualizar Quiz</button>
            </div>
        </div>


        <div id="quiz-list-screen" class="hidden">
            <button class="btn back-btn" onclick="showMainScreen()">‚Üê Volver</button>
            
            <div class="quiz-creation">
                <h2>Cuestionarios Disponibles</h2>
                <div id="quiz-list" class="quiz-list">
                    <div class="loading"></div>
                </div>
            </div>
        </div>

        <div id="start-quiz-pre-player-screen" class="hidden">
            <button class="btn back-btn" onclick="showQuizList()">‚Üê Volver a Quizzes</button>
            <div class="quiz-creation">
                <h2 id="pre-player-quiz-title"></h2>
                <p>Ingresa tu nombre para comenzar:</p>
                <div class="form-group">
                    <label for="player-name-start">Tu Nombre</label>
                    <input type="text" id="player-name-start" placeholder="Tu nombre para el quiz">
                </div>
                <button class="btn" id="confirm-start-quiz-btn" onclick="confirmStartQuiz()">Comenzar Quiz</button>
            </div>
        </div>

        <div id="quiz-player-screen" class="hidden">
            <div class="quiz-player">
                <div class="question-card">
                    <div class="timer" id="timer">30</div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    
                    <div class="question-number" id="question-number">Pregunta 1 de 5</div>
                    <div class="question-text" id="current-question"></div>
                    
                    <div class="options-grid" id="options-container">
                        </div>
                    <div id="open-answer-container-player" class="hidden">
                        <input type="text" id="open-answer-input-player" class="open-answer-input-player" placeholder="Escribe tu respuesta aqu√≠...">
                    </div>
                    
                    <button class="btn" id="submit-answer-btn" onclick="submitAnswer()">Enviar Respuesta</button>
                    <button class="btn" id="next-btn" onclick="nextQuestion()" style="display: none;">Siguiente Pregunta</button>
                    <div id="feedback-message" class="hidden"></div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <div class="quiz-creation results">
                <h2>üéâ ¬°Quiz Completado!</h2>
                <p>Jugador: <span id="player-name-display"></span></p>
                <div class="score-display celebration" id="final-score">8/10</div>
                <p id="score-message">¬°Excelente trabajo!</p>
            </div>
        </div>

        <div id="quiz-player-results-screen" class="hidden">
            <button class="btn back-btn" onclick="showQuizList()">‚Üê Volver a Quizzes</button>
            <div class="quiz-creation">
                <h2 id="quiz-results-title">Resultados de Jugadores: </h2>
                <div id="player-results-container">
                    <p>Cargando resultados...</p>
                </div>
            </div>
        </div>

        <div id="admin-dashboard-screen" class="hidden">
            <button class="btn back-btn" onclick="showMainScreen()">‚Üê Volver</button>
            <div class="quiz-creation">
                <h2>üìä Panel de Administraci√≥n</h2>
                <p>Gestiona tus quizzes y visualiza resultados en tiempo real.</p>
                <div id="admin-quiz-list">
                    <div class="loading"></div>
                </div>
                
                <div id="admin-realtime-results" class="hidden" style="margin-top: 30px;">
                    <hr style="margin-bottom: 20px;">
                    <h3 id="admin-results-quiz-title">Resultados en Vivo para: </h3>
                    <div id="admin-results-table-container">
                        <p>Esperando datos de jugadores...</p>
                    </div>
                    <button class="btn" id="download-results-btn" style="background: #28a745; margin-top: 20px; margin-right: 10px;">
                        Descargar Resultados (CSV)
                    </button>
                    <button class="btn" onclick="stopRealtimeUpdates()" style="background: #e53e3e; margin-top: 20px;">
                        Detener Monitoreo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, push, set, get, onValue, off, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

         const firebaseConfig = {
            apiKey: "AIzaSyAC3xy73lOmUxyN0HaNueTtaI_cmoIL4sY",
            authDomain: "cuestionario-5855f.firebaseapp.com",
            databaseURL: "https://cuestionario-5855f-default-rtdb.firebaseio.com",
            projectId: "cuestionario-5855f",
            storageBucket: "cuestionario-5855f.firebasestorage.app",
            messagingSenderId: "19596515431",
            appId: "1:19596515431:web:058e9e58436d2403be1cc2",
            measurementId: "G-81R4G7YSFD"
        };

        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Variables globales
        window.database = database;
        window.currentQuiz = null;
        window.currentQuizId = null;
        window.currentQuestionIndex = 0;
        window.score = 0;
        window.timer = null;
        window.timeLeft = 30;
        window.playerAnswers = [];
        window.questionCounter = 0; 
        window.playerName = ''; 
        window.realtimeListenerRef = null; 
        window.currentPlayerId = null; // Variable para el ID de la sesi√≥n del jugador actual
        window.editingQuizId = null; // New: To store the ID of the quiz being edited
        
        // Funciones para mostrar/ocultar pantallas
        window.showMainScreen = function() {
            hideAllScreens();
            stopRealtimeUpdates(); 
            document.getElementById('main-screen').classList.remove('hidden');
            // Limpiar par√°metros de URL al volver a la pantalla principal
            if (window.history.replaceState) {
                const url = new URL(window.location.href);
                url.search = '';
                window.history.replaceState({path: url.href}, '', url.href);
            }
            // Limpiar datos de localStorage relacionados con el juego actual
            localStorage.removeItem('currentQuizId');
            localStorage.removeItem('currentQuiz');
            localStorage.removeItem('currentPlayerId');
            localStorage.removeItem('currentPlayerName');
            // Resetear variables globales del jugador y edici√≥n
            window.currentQuiz = null;
            window.currentQuizId = null;
            window.currentQuestionIndex = 0;
            window.score = 0;
            window.playerName = ''; 
            window.currentPlayerId = null; 
            window.editingQuizId = null; // Reset editing state
        };

        window.showCreateQuiz = function() {
            hideAllScreens();
            stopRealtimeUpdates();
            document.getElementById('create-quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-title').value = ''; // Clear form
            document.getElementById('quiz-description').value = '';
            document.getElementById('questions-container').innerHTML = '';
            window.questionCounter = 0;
            addQuestion(); // Add first empty question
        };

        // New function to show edit quiz screen
        window.showEditQuiz = async function(quizId) {
            hideAllScreens();
            stopRealtimeUpdates();
            document.getElementById('edit-quiz-screen').classList.remove('hidden');
            window.editingQuizId = quizId; // Set the quiz ID being edited
            document.getElementById('update-quiz-btn').onclick = updateQuiz; // Ensure the update function is set

            try {
                const quizRef = ref(database, `quizzes/${quizId}`);
                const snapshot = await get(quizRef);
                if (snapshot.exists()) {
                    const quizData = snapshot.val();
                    document.getElementById('edit-quiz-title').value = quizData.title;
                    document.getElementById('edit-quiz-description').value = quizData.description;
                    document.getElementById('edit-quiz-title-heading').textContent = `Editar Quiz: ${quizData.title}`;

                    const questionsContainer = document.getElementById('edit-questions-container');
                    questionsContainer.innerHTML = ''; // Clear existing questions
                    window.questionCounter = 0; // Reset question counter for editing

                    quizData.questions.forEach(q => {
                        addQuestion('edit', q); // Pass 'edit' mode and existing question data
                    });
                    // If no questions are present, add one empty
                    if (quizData.questions.length === 0) {
                        addQuestion('edit');
                    }

                } else {
                    alert('Quiz no encontrado para editar.');
                    showAdminDashboard();
                }
            } catch (error) {
                console.error('Error al cargar quiz para edici√≥n:', error);
                alert('Error al cargar quiz para edici√≥n: ' + error.message);
                showAdminDashboard();
            }
        };


        window.showQuizList = function() {
            hideAllScreens();
            stopRealtimeUpdates();
            document.getElementById('quiz-list-screen').classList.remove('hidden');
            loadQuizList();
        };
        
        window.showStartQuizPrePlayer = function(quizId, quizTitle) {
            hideAllScreens();
            stopRealtimeUpdates();
            document.getElementById('start-quiz-pre-player-screen').classList.remove('hidden');
            document.getElementById('pre-player-quiz-title').textContent = `Comenzar Quiz: ${quizTitle}`;
            document.getElementById('confirm-start-quiz-btn').onclick = () => confirmStartQuiz(quizId);
            document.getElementById('player-name-start').value = ''; // Limpiar el campo de nombre
        };

        window.showQuizPlayerResults = function(quizId, quizTitle) {
            hideAllScreens();
            stopRealtimeUpdates();
            document.getElementById('quiz-player-results-screen').classList.remove('hidden');
            document.getElementById('quiz-results-title').textContent = `Resultados de Jugadores: ${quizTitle}`;
            loadPlayerResults(quizId);
        };

        window.showAdminDashboard = function() {
            hideAllScreens();
            stopRealtimeUpdates(); 
            document.getElementById('admin-dashboard-screen').classList.remove('hidden');
            loadAdminQuizList();
        };

        // Nueva funci√≥n para mostrar la pantalla del jugador (llamada desde join_quiz.html o direct play)
        window.showQuizPlayer = function() {
            hideAllScreens();
            document.getElementById('quiz-player-screen').classList.remove('hidden');
            showQuestion(); // Asume que currentQuiz, currentQuizId, currentPlayerId, currentPlayerName ya est√°n cargados
        };

        function hideAllScreens() {
            const screens = ['main-screen', 'create-quiz-screen', 'edit-quiz-screen', 'quiz-list-screen', 'start-quiz-pre-player-screen', 'quiz-player-screen', 'results-screen', 'quiz-player-results-screen', 'admin-dashboard-screen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        // Funciones para la creaci√≥n y EDICI√ìN de Quizzes
        window.addQuestion = function(mode = 'create', questionData = null) {
            const container = mode === 'create' ? document.getElementById('questions-container') : document.getElementById('edit-questions-container');
            const currentQuestionCount = container.children.length; // Use actual children count for new index
            const newQuestionIndex = currentQuestionCount;
            
            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block';
            questionBlock.innerHTML = `
                <h3>Pregunta ${newQuestionIndex + 1}</h3>
                <div class="form-group">
                    <label>Pregunta</label>
                    <input type="text" class="question-text-input" placeholder="Escribe tu pregunta aqu√≠...">
                </div>
                
                <div class="form-group">
                    <label>URL de Imagen (Opcional)</label>
                    <input type="text" class="question-image-input" placeholder="Pega la URL de una imagen aqu√≠ (ej: https://ejemplo.com/imagen.jpg)">
                    <img class="image-preview" src="" alt="Vista previa de imagen" style="display:none;">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" class="is-open-question"> Esta es una pregunta de respuesta abierta
                    </label>
                </div>

                <div class="form-group open-answer-group" style="display: none;">
                    <label>Respuesta esperada (para preguntas abiertas)</label>
                    <input type="text" class="open-answer-input" placeholder="Ej: La capital es Bogot√°">
                </div>

                <div class="form-group options-group">
                    <label>Opciones de respuesta (marca una o m√°s como correctas)</label>
                    <div class="option-input">
                        <input type="text" class="option-text-input" placeholder="Opci√≥n A">
                        <input type="checkbox" class="correct-answer-checkbox" value="0">
                        <label>Correcta</label>
                    </div>
                    <div class="option-input">
                        <input type="text" class="option-text-input" placeholder="Opci√≥n B">
                        <input type="checkbox" class="correct-answer-checkbox" value="1">
                        <label>Correcta</label>
                    </div>
                    <div class="option-input">
                        <input type="text" class="option-text-input" placeholder="Opci√≥n C">
                        <input type="checkbox" class="correct-answer-checkbox" value="2">
                        <label>Correcta</label>
                    </div>
                    <div class="option-input">
                        <input type="text" class="option-text-input" placeholder="Opci√≥n D">
                        <input type="checkbox" class="correct-answer-checkbox" value="3">
                        <label>Correcta</label>
                    </div>
                </div>
                <button class="btn" onclick="removeQuestion(this, '${mode}')" style="background: #f56565;">Eliminar Pregunta</button>
            `;
            container.appendChild(questionBlock);
            
            // Populate if questionData is provided (for editing)
            if (questionData) {
                questionBlock.querySelector('.question-text-input').value = questionData.question || '';
                questionBlock.querySelector('.question-image-input').value = questionData.image || '';
                
                const previewImg = questionBlock.querySelector('.image-preview');
                if (questionData.image) {
                    previewImg.src = questionData.image;
                    previewImg.style.display = 'block';
                }

                const openCheckbox = questionBlock.querySelector('.is-open-question');
                const openAnswerGroup = questionBlock.querySelector('.open-answer-group');
                const openAnswerInput = questionBlock.querySelector('.open-answer-input');
                const optionsGroup = questionBlock.querySelector('.options-group');
                
                if (questionData.isOpen) {
                    openCheckbox.checked = true;
                    openAnswerGroup.style.display = 'block';
                    openAnswerInput.value = questionData.openAnswer || '';
                    optionsGroup.style.display = 'none';
                } else {
                    openCheckbox.checked = false;
                    openAnswerGroup.style.display = 'none';
                    optionsGroup.style.display = 'block';
                    
                    const optionTextInputs = questionBlock.querySelectorAll('.option-text-input');
                    const correctAnswerCheckboxes = questionBlock.querySelectorAll('.correct-answer-checkbox');
                    
                    questionData.options.forEach((opt, idx) => {
                        if (optionTextInputs[idx]) {
                            optionTextInputs[idx].value = opt;
                        }
                    });

                    (questionData.correctAnswers || []).forEach(correctIdx => {
                        if (correctAnswerCheckboxes[correctIdx]) {
                            correctAnswerCheckboxes[correctIdx].checked = true;
                        }
                    });
                }
            }

            // Logic for image preview
            const imageInput = questionBlock.querySelector('.question-image-input');
            const previewImg = questionBlock.querySelector('.image-preview');
            imageInput.addEventListener('input', () => {
                previewImg.src = imageInput.value.trim();
                previewImg.style.display = imageInput.value.trim() ? 'block' : 'none';
            });

            // Logic for open-ended questions
            const openCheckbox = questionBlock.querySelector('.is-open-question');
            const openAnswerGroup = questionBlock.querySelector('.open-answer-group');
            const optionsGroup = questionBlock.querySelector('.options-group');

            openCheckbox.addEventListener('change', () => {
                if (openCheckbox.checked) {
                    openAnswerGroup.style.display = 'block';
                    optionsGroup.style.display = 'none';
                    // Clear multiple choice inputs if switching to open
                    optionsGroup.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
                    optionsGroup.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = false);

                } else {
                    openAnswerGroup.style.display = 'none';
                    optionsGroup.style.display = 'block';
                    // Clear open answer input if switching back
                    openAnswerGroup.querySelector('.open-answer-input').value = '';
                }
            });
        };

        window.removeQuestion = function(button, mode = 'create') {
            button.parentElement.remove();
            const container = mode === 'create' ? document.getElementById('questions-container') : document.getElementById('edit-questions-container');
            const questionBlocks = container.querySelectorAll('.question-block');
            questionBlocks.forEach((block, index) => {
                block.querySelector('h3').textContent = `Pregunta ${index + 1}`;
                // No need to adjust checkbox IDs if they are not used with specific `id` attributes or `for` labels anymore within this structure
            });
        };

        // Helper function to extract quiz data from form
        function getQuizDataFromForm(mode = 'create') {
            const titleInput = mode === 'create' ? document.getElementById('quiz-title') : document.getElementById('edit-quiz-title');
            const descriptionInput = mode === 'create' ? document.getElementById('quiz-description') : document.getElementById('edit-quiz-description');
            const questionsContainer = mode === 'create' ? document.getElementById('questions-container') : document.getElementById('edit-questions-container');

            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            
            if (!title) {
                alert('Por favor ingresa un t√≠tulo para el quiz.');
                return null;
            }

            const questions = [];
            const questionBlocks = questionsContainer.querySelectorAll('.question-block');
            
            if (questionBlocks.length === 0) {
                alert('Por favor agrega al menos una pregunta.');
                return null;
            }

            let allQuestionsValid = true;
            
            questionBlocks.forEach((block, index) => {
                const questionText = block.querySelector('.question-text-input').value.trim(); 
                const questionImage = block.querySelector('.question-image-input').value.trim();
                const isOpenQuestion = block.querySelector('.is-open-question').checked;
                const openAnswerInput = block.querySelector('.open-answer-input');
                
                if (!questionText) {
                    alert(`La Pregunta ${index + 1} no tiene texto.`);
                    allQuestionsValid = false;
                    return; 
                }

                let questionData = {
                    question: questionText,
                    image: questionImage,
                    isOpen: isOpenQuestion
                };

                if (isOpenQuestion) {
                    const openAnswer = openAnswerInput.value.trim();
                    if (!openAnswer) {
                        alert(`La Pregunta ${index + 1} es de respuesta abierta pero no tiene una respuesta esperada.`);
                        allQuestionsValid = false;
                        return;
                    }
                    questionData.openAnswer = openAnswer;
                } else {
                    const optionInputs = block.querySelectorAll('.option-text-input'); 
                    const options = Array.from(optionInputs).map(input => input.value.trim());
                    const correctAnswerCheckboxes = block.querySelectorAll('.correct-answer-checkbox:checked');
                    const correctAnswers = Array.from(correctAnswerCheckboxes).map(input => parseInt(input.value));
                    
                    if (options.some(opt => !opt)) {
                        alert(`La Pregunta ${index + 1} tiene opciones de respuesta vac√≠as.`);
                        allQuestionsValid = false;
                        return;
                    }

                    if (correctAnswers.length === 0) {
                        alert(`La Pregunta ${index + 1} de opci√≥n m√∫ltiple no tiene una respuesta correcta seleccionada.`);
                        allQuestionsValid = false;
                        return;
                    }
                    questionData.options = options;
                    questionData.correctAnswers = correctAnswers;
                }
                questions.push(questionData);
            });

            if (!allQuestionsValid) {
                return null; 
            }

            return { title, description, questions };
        }

        window.saveQuiz = async function() {
            const quizData = getQuizDataFromForm('create');
            if (!quizData) return;

            const quizCode = generateQuizCode();
            quizData.code = quizCode;
            quizData.createdAt = new Date().toISOString();

            const quizzesRef = ref(database, 'quizzes');
            const newQuizRef = push(quizzesRef);
            
            try {
                await set(newQuizRef, quizData);
                alert(`¬°Quiz guardado exitosamente! Comparte este c√≥digo: ${quizCode}`);
                showMainScreen();
                // Clear form after saving
                document.getElementById('quiz-title').value = '';
                document.getElementById('quiz-description').value = '';
                document.getElementById('questions-container').innerHTML = '';
                window.questionCounter = 0; 
                addQuestion(); 
            } catch (error) {
                console.error('Error al guardar:', error);
                alert('Error al guardar el quiz: ' + error.message);
            }
        };

        window.updateQuiz = async function() {
            if (!window.editingQuizId) {
                alert('No hay quiz seleccionado para actualizar.');
                return;
            }

            const quizData = getQuizDataFromForm('edit');
            if (!quizData) return;

            const quizRef = ref(database, `quizzes/${window.editingQuizId}`);
            
            try {
                // Fetch current quiz to retain the code
                const snapshot = await get(quizRef);
                if (!snapshot.exists()) {
                    alert('El quiz que intentas actualizar no existe.');
                    showAdminDashboard();
                    return;
                }
                const existingQuiz = snapshot.val();
                
                quizData.code = existingQuiz.code; // Retain the existing code
                quizData.updatedAt = new Date().toISOString(); // Add an updated timestamp

                await set(quizRef, quizData); // Overwrite with updated data
                alert(`¬°Quiz actualizado exitosamente!`);
                window.editingQuizId = null; // Clear editing state
                showAdminDashboard();
            } catch (error) {
                console.error('Error al actualizar:', error);
                alert('Error al actualizar el quiz: ' + error.message);
            }
        };


        function generateQuizCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // Funciones para cargar y jugar Quizzes
        async function loadQuizList() {
            const quizList = document.getElementById('quiz-list');
            quizList.innerHTML = '<div class="loading"></div>';
            
            try {
                const quizzesRef = ref(database, 'quizzes');
                const snapshot = await get(quizzesRef);
                
                if (snapshot.exists()) {
                    const quizzes = snapshot.val();
                    let html = '';
                    
                    Object.entries(quizzes).forEach(([id, quiz]) => {
                        html += `
                            <div class="quiz-item">
                                <div class="quiz-title">${quiz.title}</div>
                                <div class="quiz-meta">
                                    ${quiz.questions.length} preguntas ‚Ä¢ C√≥digo: <strong>${quiz.code}</strong>
                                </div>
                                <p>${quiz.description}</p>
                                <button class="btn" onclick="showStartQuizPrePlayer('${id}', '${quiz.title.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è Jugar</button>
                                <button class="btn" onclick="shareQuizCode('${quiz.code}')" style="background: #4CAF50; margin-left: 10px;">Compartir C√≥digo</button>
                                <button class="btn" onclick="showQuizPlayerResults('${id}', '${quiz.title.replace(/'/g, "\\'")}')" style="background: #007bff; margin-top: 10px;">Ver Resultados</button>
                            </div>
                        `;
                    });
                    
                    quizList.innerHTML = html;
                } else {
                    quizList.innerHTML = '<p>No hay cuestionarios disponibles. ¬°Crea el primero!</p>';
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
                quizList.innerHTML = '<p>Error al cargar los cuestionarios.</p>';
            }
        }

        window.shareQuizCode = function(code) {
            const shareText = `¬°Ven y juega este quiz en QuizPlatform! C√≥digo: ${code}\nLink: ${window.location.href}`;
            if (navigator.share) {
                navigator.share({
                    title: 'QuizPlatform - Juega un Quiz',
                    text: shareText,
                    url: window.location.href 
                }).then(() => {
                    console.log('C√≥digo de quiz compartido con √©xito');
                }).catch((error) => {
                    console.error('Error al compartir:', error);
                    alert(`Copia este c√≥digo y comp√°rtelo: ${code}`); 
                });
            } else {
                navigator.clipboard.writeText(code).then(() => {
                    alert(`El c√≥digo del quiz se ha copiado al portapapeles: ${code}\nComparte este link con el c√≥digo.`);
                }).catch(err => {
                    console.error('Error al copiar el c√≥digo:', err);
                    alert(`Copia este c√≥digo y comp√°rtelo: ${code}`);
                });
            }
        };

        window.confirmStartQuiz = async function(quizId) {
            const playerNameInput = document.getElementById('player-name-start').value.trim();
            if (!playerNameInput) {
                alert('Por favor ingresa tu nombre para comenzar el quiz.');
                return;
            }
            window.playerName = playerNameInput; 
            
            // Obtener el quiz para saber el total de preguntas
            const quizRef = ref(database, `quizzes/${quizId}`);
            const snapshot = await get(quizRef);
            if (!snapshot.exists()) {
                alert('El quiz no existe.');
                return;
            }
            const quizData = snapshot.val();
            const totalQuestions = quizData.questions.length;

            // Iniciar sesi√≥n de juego para el jugador
            const playersRef = ref(database, `sessions/${quizId}/players`);
            const newPlayerEntryRef = push(playersRef);
            window.currentPlayerId = newPlayerEntryRef.key; // Guarda el ID del jugador actual
            
            await set(newPlayerEntryRef, {
                name: playerNameInput,
                score: 0,
                lastAnswerTime: Date.now(),
                isFinished: false,
                totalQuestions: totalQuestions // Guardar totalQuestions al inicio
            });

            await startQuiz(quizId);
        };

        window.startQuiz = async function(quizId) {
            try {
                const quizRef = ref(database, `quizzes/${quizId}`);
                const snapshot = await get(quizRef);
                
                if (snapshot.exists()) {
                    window.currentQuiz = snapshot.val();
                    window.currentQuizId = quizId; 
                    window.currentQuestionIndex = 0;
                    window.score = 0;
                    window.playerAnswers = []; // This will store selected options for MCQs or text for open
                    
                    hideAllScreens();
                    document.getElementById('quiz-player-screen').classList.remove('hidden');
                    showQuestion();
                } else {
                    alert('El quiz seleccionado no existe.');
                    showMainScreen(); 
                }
            } catch (error) {
                alert('Error al cargar el quiz: ' + error.message);
                console.error('Error al cargar el quiz por ID:', error);
                showMainScreen(); 
            }
        };

        function showQuestion() {
            if (window.timer) {
                clearInterval(window.timer);
            }

            if (!window.currentQuiz || window.currentQuestionIndex >= window.currentQuiz.questions.length) {
                showResults(); // Ir a la pantalla de resultados cuando no hay m√°s preguntas
                return;
            }

            const question = window.currentQuiz.questions[window.currentQuestionIndex];
            const questionTextElement = document.getElementById('current-question');
            const optionsContainer = document.getElementById('options-container');
            const openAnswerContainerPlayer = document.getElementById('open-answer-container-player');
            const openAnswerInputPlayer = document.getElementById('open-answer-input-player');
            const submitAnswerBtn = document.getElementById('submit-answer-btn');
            const nextBtn = document.getElementById('next-btn');

            questionTextElement.textContent = question.question; // Set the question text

            // Clear any previous image
            const existingImage = questionTextElement.querySelector('img');
            if (existingImage) {
                existingImage.remove();
            }

            // Add image if available
            if (question.image) {
                const questionImageElement = document.createElement('img');
                questionImageElement.src = question.image;
                questionImageElement.alt = "Imagen de la pregunta";
                questionTextElement.appendChild(questionImageElement);
            }
            
            document.getElementById('question-number').textContent = 
                `Pregunta ${window.currentQuestionIndex + 1} de ${window.currentQuiz.questions.length}`;
            
            optionsContainer.innerHTML = '';
            openAnswerContainerPlayer.classList.add('hidden');
            submitAnswerBtn.style.display = 'block'; // Always show submit button, it will be handled by logic
            nextBtn.style.display = 'none';

            if (question.isOpen) {
                openAnswerContainerPlayer.classList.remove('hidden');
                openAnswerInputPlayer.value = '';
                openAnswerInputPlayer.disabled = false; // Enable input for typing
                submitAnswerBtn.onclick = () => submitOpenAnswer(); // Set specific submit for open
            } else {
                openAnswerInputPlayer.disabled = true; // Disable if not an open question
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'player-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="option-${index}" value="${index}">
                        <label for="option-${index}">${option}</label>
                    `;
                    optionsContainer.appendChild(optionDiv);

                    // Add click listener to the entire div to toggle checkbox
                    optionDiv.addEventListener('click', () => {
                        const checkbox = optionDiv.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        optionDiv.classList.toggle('selected', checkbox.checked);
                    });

                    // Prevent click on label/checkbox from triggering div's click listener twice
                    optionDiv.querySelector('input[type="checkbox"]').addEventListener('click', (e) => e.stopPropagation());
                    optionDiv.querySelector('label').addEventListener('click', (e) => e.stopPropagation());
                });
                submitAnswerBtn.onclick = () => submitMultipleChoiceAnswer(); // Set specific submit for MC
            }

            const progress = ((window.currentQuestionIndex) / window.currentQuiz.questions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            
            startTimer();
            
            // Ocultar y limpiar el feedback message al mostrar una nueva pregunta
            const feedbackMessage = document.getElementById('feedback-message');
            feedbackMessage.classList.remove('show', 'correct', 'incorrect');
            feedbackMessage.textContent = '';
        }

        function startTimer() {
            window.timeLeft = 30; 
            document.getElementById('timer').textContent = window.timeLeft;
            
            window.timer = setInterval(() => {
                window.timeLeft--;
                document.getElementById('timer').textContent = window.timeLeft;
                
                if (window.timeLeft <= 0) {
                    clearInterval(window.timer);
                    const question = window.currentQuiz.questions[window.currentQuestionIndex];

                    if (question.isOpen) {
                        // For open questions, consider it incorrect if not submitted
                        document.getElementById('open-answer-input-player').disabled = true;
                        window.playerAnswers.push({ answer: document.getElementById('open-answer-input-player').value.trim(), isCorrect: false });
                        document.getElementById('submit-answer-btn').style.display = 'none';
                    } else {
                        // For multiple choice, mark answers and disable options
                        const selectedOptions = []; // Empty array as no answer submitted
                        markMultipleChoiceAnswers(selectedOptions, question.correctAnswers);
                        window.playerAnswers.push(selectedOptions); // Store empty selected answers
                        document.querySelectorAll('.player-option input[type="checkbox"]').forEach(cb => cb.disabled = true);
                    }
                    
                    showFeedbackMessage('¬°Tiempo agotado! ‚åõ', 'incorrect');

                    if (window.currentPlayerId && window.currentQuizId) {
                        const playerSessionRef = ref(database, `sessions/${window.currentQuizId}/players/${window.currentPlayerId}`);
                        update(playerSessionRef, {
                            lastAnswerTime: Date.now() 
                        }).catch(error => {
                            console.error('Error al actualizar tiempo de jugador en timeout:', error);
                        });
                    }

                    setTimeout(() => {
                        window.currentQuestionIndex++;
                        showQuestion();
                    }, 2000); 
                }
            }, 1000);
        }

        window.submitOpenAnswer = function() {
            clearInterval(window.timer);
            const question = window.currentQuiz.questions[window.currentQuestionIndex];
            const openAnswerInputPlayer = document.getElementById('open-answer-input-player');
            const userAnswer = openAnswerInputPlayer.value.trim();
            const correctAnswer = question.openAnswer.trim();

            const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();

            if (isCorrect) {
                window.score++;
                const correctMessages = [
                    "¬°Correcto! Eres un genio üéâ",
                    "¬°Incre√≠ble! Acertaste üí™",
                    "¬°Perfecto! Sigue as√≠ ‚ú®",
                    "¬°Lo lograste! Fant√°stico üíØ"
                ];
                const randomCorrectMessage = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                showFeedbackMessage(randomCorrectMessage, 'correct');
            } else {
                const incorrectMessages = [
                    "¬°Oops! Int√©ntalo de nuevo. La pr√°ctica hace al maestro üß†",
                    "Casi lo logras. ¬°No te preocupes! üåü",
                    "Esa no era. ¬°Sigue intentando! Siempre hay una nueva oportunidad üëç",
                    "No te rindas. ¬°Est√°s cerca de dominarlo! üöÄ"
                ];
                const randomIncorrectMessage = incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];
                showFeedbackMessage(randomIncorrectMessage + ` (La respuesta era: ${correctAnswer})`, 'incorrect');
            }

            window.playerAnswers.push({ answer: userAnswer, isCorrect: isCorrect });

            // Update score in Firebase
            if (window.currentPlayerId && window.currentQuizId) {
                const playerSessionRef = ref(database, `sessions/${window.currentQuizId}/players/${window.currentPlayerId}`);
                update(playerSessionRef, {
                    score: window.score,
                    lastAnswerTime: Date.now()
                }).catch(error => {
                    console.error('Error al actualizar score de jugador:', error);
                });
            }

            openAnswerInputPlayer.disabled = true; // Disable input after submitting
            document.getElementById('submit-answer-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
        };

        window.submitMultipleChoiceAnswer = function() {
            clearInterval(window.timer);
            const question = window.currentQuiz.questions[window.currentQuestionIndex];
            const selectedCheckboxes = document.querySelectorAll('#options-container input[type="checkbox"]:checked');
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

            // Disable all checkboxes after submission
            document.querySelectorAll('#options-container input[type="checkbox"]').forEach(cb => cb.disabled = true);

            // Determine if the answer is correct
            // An answer is correct if selectedIndices exactly matches correctAnswers (order doesn't matter)
            const isCorrect = selectedIndices.length === question.correctAnswers.length &&
                              selectedIndices.every(index => question.correctAnswers.includes(index));

            if (isCorrect) {
                window.score++;
                const correctMessages = [
                    "¬°Correcto! Eres un genio üéâ",
                    "¬°Incre√≠ble! Acertaste üí™",
                    "¬°Perfecto! Sigue as√≠ ‚ú®",
                    "¬°Lo lograste! Fant√°stico üíØ"
                ];
                const randomCorrectMessage = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                showFeedbackMessage(randomCorrectMessage, 'correct');
            } else {
                const incorrectMessages = [
                    "¬°Oops! Int√©ntalo de nuevo. La pr√°ctica hace al maestro üß†",
                    "Casi lo logras. ¬°No te preocupes! üåü",
                    "Esa no era. ¬°Sigue intentando! Siempre hay una nueva oportunidad üëç",
                    "No te rindas. ¬°Est√°s cerca de dominarlo! üöÄ"
                ];
                const randomIncorrectMessage = incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];
                showFeedbackMessage(randomIncorrectMessage, 'incorrect');
            }

            // Mark correct/incorrect options visually
            markMultipleChoiceAnswers(selectedIndices, question.correctAnswers);

            window.playerAnswers.push(selectedIndices); // Store the selected indices

            // Update score in Firebase
            if (window.currentPlayerId && window.currentQuizId) {
                const playerSessionRef = ref(database, `sessions/${window.currentQuizId}/players/${window.currentPlayerId}`);
                update(playerSessionRef, {
                    score: window.score,
                    lastAnswerTime: Date.now()
                }).catch(error => {
                    console.error('Error al actualizar score de jugador:', error);
                });
            }

            document.getElementById('submit-answer-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
        };

        function markMultipleChoiceAnswers(selectedIndices, correctAnswers) {
            const optionElements = document.querySelectorAll('#options-container .player-option');
            optionElements.forEach((optionDiv, index) => {
                const checkbox = optionDiv.querySelector('input[type="checkbox"]');
                const isCorrectOption = correctAnswers.includes(index);
                const isSelected = selectedIndices.includes(index);

                if (isCorrectOption) {
                    optionDiv.classList.add('correct'); // Mark all truly correct options
                } else if (isSelected && !isCorrectOption) {
                    optionDiv.classList.add('incorrect'); // Mark selected, but incorrect options
                }
                // If an option was selected and correct, it will already be marked 'correct'
                // If an option was not selected and incorrect, no class is added
            });
        }


        // **MEJORADO: Funci√≥n para mostrar el mensaje de retroalimentaci√≥n**
        function showFeedbackMessage(message, type) {
            const feedbackMessage = document.getElementById('feedback-message');
            feedbackMessage.textContent = message;
            feedbackMessage.classList.add('show', type);

            setTimeout(() => {
                feedbackMessage.classList.remove('show', type);
                feedbackMessage.textContent = ''; 
            }, 1800); 
        }

        window.nextQuestion = function() {
            document.getElementById('next-btn').style.display = 'none'; 
            window.currentQuestionIndex++;
            showQuestion();
        };

        function showResults() {
            hideAllScreens();
            document.getElementById('results-screen').classList.remove('hidden');
            
            const scoreDisplay = document.getElementById('final-score');
            const scoreMessage = document.getElementById('score-message');
            const playerNameDisplay = document.getElementById('player-name-display'); 

            // Asegurarse de que playerName est√° disponible
            // Si el nombre no est√° en window.playerName, intenta recuperarlo de localStorage
            playerNameDisplay.textContent = window.playerName || localStorage.getItem('currentPlayerName') || 'Jugador Desconocido'; 
            
            const totalQuestions = window.currentQuiz ? window.currentQuiz.questions.length : 0;
            scoreDisplay.textContent = `${window.score}/${totalQuestions}`;
            
            const percentage = totalQuestions > 0 ? (window.score / totalQuestions) * 100 : 0;
            
            if (percentage >= 90) {
                scoreMessage.textContent = 'üèÜ ¬°Perfecto! Eres un maestro del tema.';
                scoreDisplay.classList.add('celebration');
            } else if (percentage >= 70) {
                scoreMessage.textContent = 'üéâ ¬°Muy bien! Buen dominio del tema.';
                scoreDisplay.classList.remove('celebration');
            } else if (percentage >= 50) {
                scoreMessage.textContent = 'üëç ¬°Bien hecho! Puedes mejorar un poco m√°s.';
                scoreDisplay.classList.remove('celebration');
            } else {
                scoreMessage.textContent = 'üìö ¬°Sigue practicando! La pr√°ctica hace al maestro.';
                scoreDisplay.classList.remove('celebration');
            }

            savePlayerResult();
        }

        async function savePlayerResult() {
            // Asegurarse de que currentPlayerId y currentQuizId est√°n definidos antes de intentar guardar
            if (window.currentQuizId && window.currentPlayerId && window.currentQuiz) {
                const playerSessionRef = ref(database, `sessions/${window.currentQuizId}/players/${window.currentPlayerId}`);
                try {
                    await update(playerSessionRef, {
                        score: window.score,
                        totalQuestions: window.currentQuiz.questions.length, // Asegurar que se guarda el total
                        isFinished: true, // Marcar que ha terminado el juego
                        timestamp: new Date().toISOString() // Registrar el tiempo final
                    });
                    console.log('Resultado final del jugador actualizado en Firebase.');
                } catch (error) {
                    console.error('Error al guardar el resultado final del jugador:', error);
                }
            } else {
                console.warn('No se pudo guardar el resultado del jugador: Faltan quizId, currentPlayerId o currentQuiz.');
            }
        }

        async function loadPlayerResults(quizId) {
            const playerResultsContainer = document.getElementById('player-results-container');
            playerResultsContainer.innerHTML = '<div class="loading"></div>';

            try {
                // Busca en las sesiones activas, no en quizzes directamente
                const sessionsRef = ref(database, `sessions/${quizId}/players`); 
                const snapshot = await get(sessionsRef);

                if (snapshot.exists()) {
                    const players = snapshot.val();
                    
                    // Filtrar solo los jugadores que han finalizado el juego (isFinished: true)
                    // Y obtener los datos m√°s recientes y/o mejores de cada jugador por nombre si hay duplicados
                    const processedPlayers = {}; 
                    Object.values(players).forEach(player => {
                        // Solo considerar jugadores que han terminado el quiz y tienen totalQuestions
                        if (player.isFinished && player.totalQuestions !== undefined && player.totalQuestions !== null) { 
                            // If a result already exists for this name, update if the current one is more recent/better
                            if (!processedPlayers[player.name] || 
                                (player.score > processedPlayers[player.name].score) ||
                                (player.score === processedPlayers[player.name].score && new Date(player.timestamp) > new Date(processedPlayers[player.name].timestamp))
                            ) {
                                processedPlayers[player.name] = player;
                            }
                        }
                    });

                    const sortedPlayers = Object.values(processedPlayers).sort((a, b) => b.score - a.score);

                    let tableHtml = `
                        <table class="player-results-table">
                            <thead>
                                <tr>
                                    <th>Posici√≥n</th>
                                    <th>Nombre</th>
                                    <th>Puntuaci√≥n</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    if (sortedPlayers.length > 0) {
                        sortedPlayers.forEach((player, index) => {
                            const date = player.timestamp ? new Date(player.timestamp).toLocaleString() : 'N/A';
                            // Un jugador es 'winner' si es el primero Y ha terminado el quiz
                            const isWinner = (index === 0 && player.isFinished);
                            tableHtml += `
                                <tr class="${isWinner ? 'winner' : ''}">
                                    <td>${index + 1}</td>
                                    <td>${player.name}</td>
                                    <td>${player.score}/${player.totalQuestions || 'N/A'}</td>
                                    <td>${date}</td>
                                </tr>
                            `;
                        });
                    } else {
                        tableHtml += `<tr><td colspan="4">No hay resultados finalizados para mostrar.</td></tr>`;
                    }

                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    playerResultsContainer.innerHTML = tableHtml;
                } else {
                    playerResultsContainer.innerHTML = '<p>A√∫n no hay resultados de jugadores para este quiz.</p>';
                }
            } catch (error) {
                console.error('Error al cargar los resultados de los jugadores:', error);
                playerResultsContainer.innerHTML = '<p>Error al cargar los resultados de los jugadores.</p>';
            }
        }


        window.playAgain = function() {
            // Reinicia las variables del juego
            window.currentQuestionIndex = 0;
            window.score = 0;
            window.playerAnswers = [];
            // Limpiar datos de localStorage del juego actual
            localStorage.removeItem('currentQuizId');
            localStorage.removeItem('currentQuiz');
            localStorage.removeItem('currentPlayerId');
            localStorage.removeItem('currentPlayerName');
            window.currentQuiz = null;
            window.currentQuizId = null;
            window.currentPlayerId = null;
            window.playerName = '';

            // Volver a la pantalla principal para que el usuario elija qu√© hacer
            showMainScreen(); 
        };

        // **MEJORADO: Funciones para el Panel de Administraci√≥n**
        async function loadAdminQuizList() {
            const adminQuizList = document.getElementById('admin-quiz-list');
            adminQuizList.innerHTML = '<div class="loading"></div>';

            try {
                const quizzesRef = ref(database, 'quizzes');
                const snapshot = await get(quizzesRef);
                
                if (snapshot.exists()) {
                    const quizzes = snapshot.val();
                    let html = '';
                    Object.entries(quizzes).forEach(([id, quiz]) => {
                        html += `
                            <div class="admin-quiz-item">
                                <div>
                                    <h3>${quiz.title}</h3>
                                    <p>C√≥digo: <strong>${quiz.code}</strong> ‚Ä¢ Preguntas: ${quiz.questions.length}</p>
                                </div>
                                <div>
                                    <button class="btn btn-edit" onclick="showEditQuiz('${id}')">
                                        Editar Quiz
                                    </button>
                                    <button class="btn" onclick="startRealtimeMonitor('${id}', '${quiz.title.replace(/'/g, "\\'")}')">
                                        Ver Resultados en Vivo
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteQuiz('${id}', '${quiz.title.replace(/'/g, "\\'")}')">
                                        Eliminar Quiz
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    adminQuizList.innerHTML = html;
                } else {
                    adminQuizList.innerHTML = '<p>No hay quizzes para administrar.</p>';
                }
            }
            catch (error) {
                console.error('Error al cargar quizzes para admin:', error);
                adminQuizList.innerHTML = '<p>Error al cargar la lista de quizzes para el panel de administraci√≥n.</p>';
            }
        }

        // **MEJORADO: Iniciar monitoreo en tiempo real de un quiz**
        window.startRealtimeMonitor = function(quizId, quizTitle) {
            stopRealtimeUpdates(); 

            document.getElementById('admin-realtime-results').classList.remove('hidden');
            document.getElementById('admin-results-quiz-title').textContent = `Resultados en Vivo para: ${quizTitle}`;
            const resultsContainer = document.getElementById('admin-results-table-container');
            resultsContainer.innerHTML = '<p>Cargando resultados en tiempo real...</p>';

            // Set up the download button's click handler
            const downloadBtn = document.getElementById('download-results-btn');
            downloadBtn.onclick = () => downloadAdminResultsCSV(quizId, quizTitle);
            
            const playersRef = ref(database, `sessions/${quizId}/players`); // Ahora escucha en 'sessions'
            window.realtimeListenerRef = playersRef; 

            onValue(playersRef, (snapshot) => {
                if (snapshot.exists()) {
                    const players = snapshot.val();
                    let tableHtml = `
                        <table class="player-results-table">
                            <thead>
                                <tr>
                                    <th>Posici√≥n</th>
                                    <th>Nombre</th>
                                    <th>Puntuaci√≥n</th>
                                    <th>Estado</th>
                                    <th>√öltima Actividad</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    // Convertir a array y ordenar por puntuaci√≥n descendente, luego por √∫ltima actividad
                    const sortedPlayers = Object.values(players).sort((a, b) => {
                        if (b.score !== a.score) {
                            return b.score - a.score;
                        }
                        // Si tienen el mismo score, el que termin√≥ primero o el que tiene actividad m√°s reciente
                        if (a.isFinished && !b.isFinished) return -1; // Finalizado antes que no finalizado
                        if (!a.isFinished && b.isFinished) return 1;
                        return (new Date(b.timestamp || b.lastAnswerTime)) - (new Date(a.timestamp || a.lastAnswerTime));
                    });
                    
                    sortedPlayers.forEach((player, index) => {
                        const status = player.isFinished ? 'Completado ‚úÖ' : 'Jugando...';
                        const lastActivity = player.timestamp ? new Date(player.timestamp).toLocaleTimeString() : (player.lastAnswerTime ? new Date(player.lastAnswerTime).toLocaleTimeString() : 'N/A');
                        
                        // Un jugador es 'winner' si es el primero Y ha terminado el quiz
                        const isWinner = (index === 0 && player.isFinished);
                        
                        tableHtml += `
                            <tr class="${isWinner ? 'winner' : ''}">
                                <td>${index + 1}</td>
                                <td>${player.name}</td>
                                <td>${player.score}/${player.totalQuestions || 'N/A'}</td>
                                <td>${status}</td>
                                <td>${lastActivity}</td>
                            </tr>
                        `;
                    });

                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    resultsContainer.innerHTML = tableHtml;
                } else {
                    resultsContainer.innerHTML = '<p>A√∫n no hay resultados de jugadores para este quiz.</p>';
                }
            }, (error) => {
                console.error('Error en el monitoreo en tiempo real:', error);
                resultsContainer.innerHTML = '<p>Error al cargar los resultados en tiempo real.</p>';
            });
        };

        // **MEJORADO: Detener monitoreo en tiempo real**
        window.stopRealtimeUpdates = function() {
            if (window.realtimeListenerRef) {
                off(window.realtimeListenerRef); 
                window.realtimeListenerRef = null;
                console.log('Monitoreo en tiempo real detenido.');
            }
            document.getElementById('admin-realtime-results').classList.add('hidden');
            document.getElementById('admin-results-table-container').innerHTML = ''; 
            // Clear the download button's click handler when monitoring stops
            document.getElementById('download-results-btn').onclick = null;
        };

        // **NUEVO: Funci√≥n para eliminar un quiz**
        window.deleteQuiz = async function(quizId, quizTitle) {
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el quiz "${quizTitle}"? Esta acci√≥n es irreversible.`)) {
                try {
                    const quizRef = ref(database, `quizzes/${quizId}`);
                    const sessionsRef = ref(database, `sessions/${quizId}`); // Tambi√©n eliminar sesiones asociadas
                    await remove(quizRef);
                    await remove(sessionsRef); // Eliminar las sesiones de juego
                    alert(`El quiz "${quizTitle}" y sus sesiones asociadas han sido eliminados exitosamente.`);
                    loadAdminQuizList(); // Recargar la lista de quizzes en el panel de administraci√≥n
                    stopRealtimeUpdates(); // Detener el monitoreo si se estaba viendo este quiz
                } catch (error) {
                    console.error('Error al eliminar el quiz:', error);
                    alert('Error al eliminar el quiz: ' + error.message);
                }
            }
        };

        // Helper function to escape CSV fields
        function escapeCsvField(field) {
            if (field === null || field === undefined) {
                return '""'; // Represent null/undefined as empty string in CSV
            }
            // Convert to string, replace all double quotes with two double quotes, then wrap in double quotes
            let stringField = String(field);
            return `"${stringField.replace(/"/g, '""')}"`;
        }

        // NEW FUNCTION TO DOWNLOAD RESULTS AS CSV (IMPROVED FOR EXCEL)
        window.downloadAdminResultsCSV = async function(quizId, quizTitle) {
            try {
                const sessionsRef = ref(database, `sessions/${quizId}/players`);
                const snapshot = await get(sessionsRef);

                if (!snapshot.exists()) {
                    alert('No hay datos de jugadores para descargar para este quiz.');
                    return;
                }

                const players = snapshot.val();
                const processedPlayers = {};
                Object.values(players).forEach(player => {
                    if (player.name) { // Ensure player has a name
                        if (!processedPlayers[player.name] || 
                            (player.score > (processedPlayers[player.name].score || 0)) ||
                            (player.score === (processedPlayers[player.name].score || 0) && new Date(player.timestamp || player.lastAnswerTime) > new Date(processedPlayers[player.name].timestamp || processedPlayers[player.name].lastAnswerTime))
                        ) {
                            processedPlayers[player.name] = player;
                        }
                    }
                });

                const sortedPlayers = Object.values(processedPlayers).sort((a, b) => b.score - a.score);

                // Add BOM for UTF-8 compatibility in Excel
                const BOM = "\ufeff"; 
                let csvContent = BOM;
                csvContent += "Posici√≥n,Nombre,Puntuaci√≥n,Total Preguntas,Estado,√öltima Actividad (Fecha),√öltima Actividad (Hora)\n";

                sortedPlayers.forEach((player, index) => {
                    const status = player.isFinished ? 'Completado' : 'Jugando';
                    const lastActivityDateObj = player.timestamp ? new Date(player.timestamp) : (player.lastAnswerTime ? new Date(player.lastAnswerTime) : null);
                    const datePart = lastActivityDateObj ? lastActivityDateObj.toLocaleDateString() : 'N/A';
                    const timePart = lastActivityDateObj ? lastActivityDateObj.toLocaleTimeString() : 'N/A';
                    
                    csvContent += [
                        escapeCsvField(index + 1),
                        escapeCsvField(player.name),
                        escapeCsvField(player.score !== undefined ? player.score : 'N/A'),
                        escapeCsvField(player.totalQuestions !== undefined ? player.totalQuestions : 'N/A'),
                        escapeCsvField(status),
                        escapeCsvField(datePart),
                        escapeCsvField(timePart)
                    ].join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${quizTitle}_resultados.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else {
                    // Fallback for browsers that don't support the download attribute
                    window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
                }
                alert('¬°Resultados descargados exitosamente en formato CSV!');

            } catch (error) {
                console.error('Error al descargar los resultados:', error);
                alert('Error al descargar los resultados: ' + error.message);
            }
        };

        // Inicializar la aplicaci√≥n al cargar el DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Check if the current screen should be `create-quiz-screen` and add first question
            if (document.getElementById('create-quiz-screen').classList.contains('hidden') === false) {
                 if (document.getElementById('questions-container').children.length === 0) {
                    addQuestion('create');
                }
            }
           
            // L√ìGICA PARA MANEJAR LA REDIRECCI√ìN DESDE join_quiz.html o iniciar juego directo
            const urlParams = new URLSearchParams(window.location.search);
            const screenParam = urlParams.get('screen');
            const quizIdParam = urlParams.get('quizId');

            if (screenParam === 'player' && quizIdParam) {
                // Cargar los datos del quiz y jugador desde localStorage
                const storedQuiz = localStorage.getItem('currentQuiz');
                const storedPlayerId = localStorage.getItem('currentPlayerId');
                const storedPlayerName = localStorage.getItem('currentPlayerName');

                if (storedQuiz && storedPlayerId && storedPlayerName) {
                    window.currentQuiz = JSON.parse(storedQuiz);
                    window.currentPlayerId = storedPlayerId;
                    window.playerName = storedPlayerName; // Asegurar que playerName est√© en window
                    window.currentQuizId = quizIdParam; // Asegurarse de tener el ID del quiz

                    showQuizPlayer(); // Mostrar la pantalla del jugador del quiz
                } else {
                    // Si falta informaci√≥n, volver a la pantalla principal y limpiar localStorage
                    alert('Error al iniciar el quiz. Por favor, intenta unirte de nuevo o selecciona un quiz para jugar.');
                    localStorage.removeItem('currentQuizId');
                    localStorage.removeItem('currentQuiz');
                    localStorage.removeItem('currentPlayerId');
                    localStorage.removeItem('currentPlayerName');
                    showMainScreen(); // Ir a la pantalla principal sin intentar jugar
                }
            } else {
                showMainScreen(); // Mostrar la pantalla principal por defecto si no hay par√°metros de juego
            }
        });
    </script>
</body>
</html>
